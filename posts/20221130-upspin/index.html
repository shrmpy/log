<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Dev Journey</title><link rel=stylesheet href=https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css><link rel=stylesheet href=/assets/gradient.css><link href=/assets/favicon.svg rel=icon type=image/svg></head><body><div class="fl min-vh-100 w-100 bg-light-silver navy"><h1 id=upspin>Upspin</h1><p><a href=https://upspin.io>=> Upspin Project</a>
<a href=https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/getting_started>=> Google Provider Intro</a></p><h2 id=1-remember>ยง1 /Remember</h2><p>Start at the server page to get familiar, jog memory
<a href=https://upspin.io/doc/server_setup.md>=> Upspin Server</a></p><p>Keep in mind we&rsquo;ll skip around because we actually have our registration from years ago when we did our first test drive. Read down to the subheading for <em>Specific instructions for cloud services</em>, making sure everything looks good so far (the instructions should not be a surprise as we completed them once before).</p><p>Next visit the GCP page to continue
<a href=https://upspin.io/doc/server_setup_gcp.md>=> Setup Google Compute</a></p><h2 id=2-upspinserver>ยง2 /Upspinserver</h2><p>Stick to the instructions on building <code>upspinserver-gcp</code> and <code>upspin-setupstorage-gcp</code> with only minor adjustments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir uptest <span style=color:#f92672>&amp;&amp;</span> cd uptest
</span></span><span style=display:flex><span>go mod init example.com/uptest
</span></span><span style=display:flex><span>go get -d gcp.upspin.io/cmd/...
</span></span><span style=display:flex><span>go install gcp.upspin.io/cmd/upspin-setupstorage-gcp
</span></span><span style=display:flex><span>GOOS<span style=color:#f92672>=</span>linux GOARCH<span style=color:#f92672>=</span>arm64 go build gcp.upspin.io/cmd/upspinserver-gcp
</span></span></code></pre></div><p>The <code>GOOS</code> and <code>GOARCH</code> env values are for the Google Compute machine type which in our case will be ARM (<code>t2a-standard-1</code>).</p><h2 id=3-gcp>ยง3 /GCP</h2><p>We are recycling the Google Cloud Project and skipped creation this time around. With the Google Cloud SDK, the snapcraft option was the easiest.</p><p>TBD check Google Cloud Storage bucket steps (because &ldquo;Bucket already exists&rdquo;)</p><p>Now it&rsquo;s time to provision the Google Compute machine (<code>t2a-standard-1</code>). Collected into Terraform HCL (where <em>MY-SUBDOMAIN-EXAMPLE-COM</em> is a placeholder and should be replaced with a real value):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-main.tf data-lang=main.tf><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;google&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>project</span> = <span style=color:#e6db74>&#34;MY-SUBDOMAIN-EXAMPLE-COM&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>zone</span> = <span style=color:#e6db74>&#34;us-central1-a&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_network&#34;</span> <span style=color:#e6db74>&#34;vpc_network&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;my-custom-mode-net&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>auto_create_subnetworks</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mtu</span> = <span style=color:#ae81ff>1460</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_subnetwork&#34;</span> <span style=color:#e6db74>&#34;default&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;my-custom-subnet&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ip_cidr_range</span> = <span style=color:#e6db74>&#34;10.0.1.0/24&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network</span> = <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>vpc_network</span>.<span style=color:#a6e22e>self_link</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Create a single Compute Engine instance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_instance&#34;</span> <span style=color:#e6db74>&#34;vm_instance&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;upspin-MY-SUBDOMAIN-EXAMPLE-COM&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>machine_type</span> = <span style=color:#e6db74>&#34;t2a-standard-1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allow_stopping_for_update</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tags</span> = [<span style=color:#e6db74>&#34;ssh&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>boot_disk</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initialize_params</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>image</span> = <span style=color:#e6db74>&#34;debian-11-arm&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>size</span> = <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Install Flask (python cgi)
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ##metadata_startup_script = &#34;sudo apt-get update; sudo apt-get install -yq build-essential python3-pip rsync; pip install flask&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # TODO kept here as reminder because we will use upspin command to deploy to the instance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network_interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nic_type</span> = <span style=color:#e6db74>&#34;GVNIC&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>subnetwork</span> = <span style=color:#a6e22e>google_compute_subnetwork</span>.<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>self_link</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>access_config</span> {<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>      # Include this section to give the VM an external IP address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_firewall&#34;</span> <span style=color:#e6db74>&#34;ssh&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;allow-ssh&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allow</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ports</span> = [<span style=color:#e6db74>&#34;22&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span> = <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>direction</span> = <span style=color:#e6db74>&#34;INGRESS&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network</span> = <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>vpc_network</span>.<span style=color:#a6e22e>self_link</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>priority</span> = <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source_ranges</span> = [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>target_tags</span> = [<span style=color:#e6db74>&#34;ssh&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_firewall&#34;</span> <span style=color:#e6db74>&#34;upspin&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;upspin-app-firewall&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network</span> = <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>vpc_network</span>.<span style=color:#a6e22e>self_link</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allow</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span> = <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ports</span> = [<span style=color:#e6db74>&#34;80&#34;</span>, <span style=color:#e6db74>&#34;443&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source_ranges</span> = [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>##resource &#34;google_compute_snapshot&#34; &#34;upspin_server_snapshot&#34; {
</span></span></span><span style=display:flex><span><span style=color:#75715e>##  name = &#34;upspin-20221129-ubuntu2204lts&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>##  source_disk = google_compute_instance.vm_instance.self_link
</span></span></span><span style=display:flex><span><span style=color:#75715e>##}
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># A variable for extracting the external IP address of the VM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;Upspin-server-URL&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value</span> = join(<span style=color:#e6db74>&#34;&#34;</span>, [<span style=color:#e6db74>&#34;http://&#34;</span>, <span style=color:#a6e22e>google_compute_instance</span>.<span style=color:#a6e22e>vm_instance</span>.<span style=color:#a6e22e>network_interface</span>.<span style=color:#ae81ff>0</span>.<span style=color:#a6e22e>access_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#a6e22e>nat_ip</span>, <span style=color:#e6db74>&#34;:80&#34;</span>])
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The assigned IP should be displayed at the end of deployment. The rest of the instructions for DNS, upload, and configuration of the upspinserver binary can be followed as described.</p><hr><h2 id=-notes-lessons-monologue>* Notes, Lessons, Monologue</h2><ul><li><p>Why use ephemeral IP? shouldn&rsquo;t it be a static IP. TBD</p></li><li><p>What is the snapshot about? TBD</p></li><li><p>Why Terraform? <code>terraform destroy</code> when we need to undo/start over is very convenient. The alternative was to reverse the GCP steps using the console UI.</p></li><li><p>Why Terraform? No installation required. The GCP console has a shell tool that is embedded inside the web browser. It will link to the project at launch. It also stores the state of the Terraform deployments; similar to choosing Terraform Cloud to be the backend for the state data.</p></li><li><p>Why choose a ARM machine type? At least until Apr 2023, the free tier treats this machine type as a trial. Which means it will need revisiting later to make sure the pricing isn&rsquo;t a sudden surprise.</p></li></ul><h6 id=2023-่ๆก--keep-calm-and-bugfix-on>2023 ่ๆก | Keep Calm and bugfix on</h6></div></body></html>