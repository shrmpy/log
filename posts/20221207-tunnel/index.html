<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Dev Journey</title><link rel=stylesheet href=https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css><link rel=stylesheet href=/assets/gradient.css><link href=/assets/favicon.svg rel=icon type=image/svg></head><body><div class="fl min-vh-100 w-100 bg-light-silver navy"><h1 id=cloudflare-tunnel>Cloudflare Tunnel</h1><p><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/local/#set-up-a-tunnel-locally-cli-setup>=> Install cloudflared</a>
<a href=https://humungus.tedunangst.com/r/honk>=> Honk Manual</a></p><h2 id=1-cloudflared>§1 /Cloudflared</h2><p>For FreeBSD, the makefile has the line indicating how to build cloudflared:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone --depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> https://github.com/cloudflare/cloudflared.git
</span></span><span style=display:flex><span>cd cloudflared
</span></span><span style=display:flex><span>GOOS<span style=color:#f92672>=</span>freebsd GOARCH<span style=color:#f92672>=</span>amd64 go build -mod<span style=color:#f92672>=</span>vendor -v ./cmd/cloudflared
</span></span></code></pre></div><h2 id=2-honk>§2 /Honk</h2><p>Honk requires the libraries for SQLite3. Then just follow the steps from the admin manual:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go install humungus.tedunangst.org/r/honk@latest
</span></span><span style=display:flex><span>honk -datadir ./honking init
</span></span><span style=display:flex><span>honk -datadir ./honking admin
</span></span><span style=display:flex><span>cp -R ~/devel/honk/views .
</span></span><span style=display:flex><span>honk -datadir ./honking -log honk.log run
</span></span></code></pre></div><h2 id=3-configure>§3 /Configure</h2><p>Prefer the commandline method for creating the tunnel (described on the Cloudflare page).
Then make the configuration file <code>.cloudflared/config.yml</code> to redirect webfinger:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-config.yml data-lang=config.yml><span style=display:flex><span><span style=color:#f92672>tunnel</span>: <span style=color:#ae81ff>&lt;Tunnel-ID&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>credentials-file</span>: <span style=color:#ae81ff>/home/unprivileged/.cloudflared/&lt;Tunnel-ID&gt;.json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ingress</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>honk.example.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>\.?well-known</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>http://localhost:8077</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>honk.example.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>http://localhost:31337</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>http_status:404</span>
</span></span></code></pre></div><hr><h2 id=-notes-lessons-monologue>* Notes, Lessons, Monologue</h2><ul><li><p>Why redirect webfinger? There seems to be sanitizing by the tunnel which removes the dot prefix from the URL. It never reaches the webfinger route on its own. We wrote a simple webfinger server to only respond with the static webfinger JSON. Then tested by making the regex path for both dot/none prefix, and forwarded to this static server on port <code>8077</code>. At that point, going to <code>https://webfinger.net</code> and searching for our <code>username@honk.example.com</code> became successful.</p></li><li><p>Why tunnel? So Cloudflare made the cloudflared tunnel available for free otherwise we wouldn&rsquo;t even try. That&rsquo;s reason #1. Next, it had a great claim which was to hide your internal services. In the past, I think this only applied to HTTP/S, but the features have expanded to TCP and more ports. Anyways if the configuration fits, we never have to expose public IP addresses; the Cloudflare proxy becomes the public layer and our services stay inside private subnets (e.g., 10.0.0.1). We don&rsquo;t need to configure firewall rules or spin up our own VPN. We need to have a domain name such as <code>example.com</code> then our service listening at <code>http://localhost:8077</code> can be accessed externally by <code>https://example.com</code>. Besides the frictionless setup, having Cloudflare as the public surface should give one element of security because known attackers can be detected by Cloudflare infrastructure before they forward the request to our server.</p></li></ul><h6 id=2023-興怡--keep-calm-and-bugfix-on>2023 興怡 | Keep Calm and bugfix on</h6></div></body></html>